version: v1.0
name: Unit Tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Setup
    task:
      secrets:
        - name: ssh-keys

      prologue:
        commands:
          # Correct permissions and add key to ssh agent
          # When running a session from debug mode, also need to run:
          # eval "$(ssh-agent -s)"
          - chmod 0600 ~/.ssh/github
          - ssh-add ~/.ssh/github
      jobs:
        - name: Bundle install
          commands:
            - checkout
            - cache restore
            - bundle install --deployment -j 4 --path vendor/bundle
            - cache store

  - name: Unit tests
    task:
      secrets:
        - name: ssh-keys

      env_vars:
        - name: RAILS_ENV
          value: "test"

      prologue:
        commands:
          # Correct permissions and add key to ssh agent
          # When running a session from debug mode, also need to run:
          # eval "$(ssh-agent -s)"
          - chmod 0600 ~/.ssh/github
          - ssh-add ~/.ssh/github
          - checkout
          - cache restore

          - sem-service start mysql 5.7

          - bundle install --deployment --path vendor/bundle
          - bundle exec rake db:migrate

          - pushd test/dummy
          - rake
          - popd

      jobs:
        - name: Tests
          commands:
            - bundle exec rake